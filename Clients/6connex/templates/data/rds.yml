---
AWSTemplateFormatVersion: 2010-09-09
Description: >-
  It creates 2 rds instances for infra - db6c and dw6c
Parameters:
  Identifier:
    Type: String
    Description: A name identifier for the RDS instance
  ################## general ##############################
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC to host the RDS instance
  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Subnet Ids to host the RDS instance
  RdsSecurityGroup:
    Type: String
    Description: Security Group ID for the RDS Instace
  ################## DB ##############################
  UserDb:
    Type: String
    Description: Username for db6c database instance
  PasswordDb:
    Type: String
    NoEcho: true
    Description: Password for db6c database instance
  ClassDb:
    Type: String
    Description: Class for db6c database instance
  AllocatedStorageDb:
    Type: String
    Description: allocated Storage for db6c database instance
  EncryptDb:
    Type: String
    Default: 'true'
    Description: enables encryption on database
  ################## DB ##############################
  UserDw:
    Type: String
    Description: Username for dw6c database instance
  PasswordDw:
    Type: String
    NoEcho: true
    Description: Password for dw6c database instance
  ClassDw:
    Type: String
    Description: Class for dw6c database instance
  EncryptDw:
    Type: String
    Default: 'true'
    Description: enables encryption on database
  AllocatedStorageDw:
    Type: String
    Description: allocated Storage for dw6c database instance
  MultiAz:
    Type: String
    Default: false
    Description: creates a multi az dbs
    AllowedValues:
    - true
    - false
  ################## general ##############################
  KmsKeyId:
    Type: String
    Default: ''
    Description: Kms key for encryption
  OwnerName:
    Type: String
    Description: An arbitrary tag name for the owner of these resources
  ProjectName:
    Type: String
    Description: The name of the project to which these resources belong
  Environment:
    Type: String
    Description: Environment name to append to resources names and tags

Conditions:

  IsProduction: !Equals [!Ref Environment, 'prod']
  NoKmsKey: !Equals [!Ref KmsKeyId, '']

Resources:
  SubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      SubnetIds: !Ref SubnetIds
      DBSubnetGroupName: !Sub ${Identifier}-${Environment}-subnetgroup
      DBSubnetGroupDescription: !Sub Subnets available for ${Identifier}-${Environment} RDS

  ParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: Parameter Group for ${Identifier}-${Environment} - ${DbFamily}
      Family: mysql5.6
      Parameters:
        log_bin_trust_function_creators: 1

  DbCredentialsSecrets:
    Type: AWS::SecretsManager::Secret
    Properties: 
      Description: !Sub Db credentials secret in env ${Environment}
      Name: !Sub ${Environment}/${Identifier}/DB/DbCredentials
      SecretString: !Sub '{"username":"${UserDb}","password":"${PasswordDb}"}'
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${Environment}-db-credentials
      - Key: Owner
        Value: !Ref OwnerName
      - Key: ProjectName
        Value: !Ref ProjectName
      - Key: Environment
        Value: !Ref Environment

  DbInstance:
    Type: AWS::RDS::DBInstance
    DependsOn:
      - SubnetGroup
      - ParameterGroup
      - DbCredentialsSecrets
    Properties:
      DBInstanceIdentifier: !Sub ${Identifier}-${Environment}-6codb
      Engine: mysql
      EngineVersion: 5.6.44
      MultiAZ: !Ref MultiAz
      StorageType: io1
      Iops: 1000
      BackupRetentionPeriod: 7
      MasterUsername: !Sub '{{resolve:secretsmanager:${DbCredentialsSecrets}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DbCredentialsSecrets}:SecretString:password}}'
      DBInstanceClass: !Ref ClassDb
      AllocatedStorage: !Ref AllocatedStorageDb
      DBParameterGroupName: !Ref ParameterGroup
      StorageEncrypted: !Ref EncryptDb
      KmsKeyId: !If [ NoKmsKey, !Ref 'AWS::NoValue', !Ref KmsKeyId ]
      VPCSecurityGroups:
      - !Ref RdsSecurityGroup
      DBSubnetGroupName: !Ref SubnetGroup
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${Environment}-6cdb
      - Key: Owner
        Value: !Ref OwnerName
      - Key: ProjectName
        Value: !Ref ProjectName
      - Key: Environment
        Value: !Ref Environment

  DbEndpointParameter:
    Type: AWS::SSM::Parameter
    Properties: 
      Name: !Sub /${Environment}/${Identifier}/DB/DbEndpoint
      Type: String
      Value: !GetAtt DbInstance.Endpoint.Address
      Description: !Sub Db endpoint on Environment ${Environment}
      Tags:
        Name: !Sub /${Environment}/${Identifier}/DB/DbEndpoint
        OwnerName: !Ref OwnerName
        ProjectName: !Ref ProjectName
        Environment: !Ref  Environment

  DwCredentialsSecrets:
    Type: AWS::SecretsManager::Secret
    Properties: 
      Description: !Sub Dw credentials secret in env ${Environment}
      Name: !Sub ${Environment}/${Identifier}/DB/DwCredentials
      SecretString: !Sub '{"username":"${UserDw}","password":"${PasswordDw}"}'
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${Environment}-dw-credentials
      - Key: Owner
        Value: !Ref OwnerName
      - Key: ProjectName
        Value: !Ref ProjectName
      - Key: Environment
        Value: !Ref Environment

  DwInstance:
    Type: AWS::RDS::DBInstance
    Condition: IsProduction
    DependsOn:
      - SubnetGroup
      - ParameterGroup
      - DwCredentialsSecrets
    Properties:
      DBInstanceIdentifier: !Sub ${Identifier}-${Environment}-6codw
      Engine: mysql
      EngineVersion: 5.6.44
      MultiAZ: !Ref MultiAz
      StorageType: io1
      Iops: 1000
      BackupRetentionPeriod: 7
      MasterUsername: !Sub '{{resolve:secretsmanager:${DwCredentialsSecrets}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${DwCredentialsSecrets}:SecretString:password}}'
      DBInstanceClass: !Ref ClassDw
      AllocatedStorage: !Ref AllocatedStorageDw
      DBParameterGroupName: !Ref ParameterGroup
      StorageEncrypted: !Ref EncryptDw
      KmsKeyId: !If [ NoKmsKey, !Ref 'AWS::NoValue', !Ref KmsKeyId ]
      VPCSecurityGroups:
      - !Ref RdsSecurityGroup
      DBSubnetGroupName: !Ref SubnetGroup
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${Environment}-6cdw
      - Key: Owner
        Value: !Ref OwnerName
      - Key: ProjectName
        Value: !Ref ProjectName
      - Key: Environment
        Value: !Ref Environment

  DwEndpointParameter:
    Type: AWS::SSM::Parameter
    Properties: 
      Name: !Sub /${Environment}/${Identifier}/DB/DwEndpoint
      Type: String
      Value: !If [IsProduction, !GetAtt DwInstance.Endpoint.Address, 'No-Endpoint'] 
      Description: !Sub Dw endpoint on Environment ${Environment}
      Tags:
        Name: !Sub /${Environment}/${Identifier}/DB/DwEndpoint
        OwnerName: !Ref OwnerName
        ProjectName: !Ref ProjectName
        Environment: !Ref  Environment
        
Outputs:
  DbEndpoint:
    Description: db6c endpoint address
    Value: !GetAtt DbInstance.Endpoint.Address

  DwEndpoint:
    Condition: IsProduction
    Description: dw6c endpoint address
    Value: !GetAtt DwInstance.Endpoint.Address

  DbEndpointName:
    Description: db endpoint parameter name
    Value: !Sub /${Environment}/${Identifier}/DB/DbEndpoint

  DwEndpointName:
    Description: dw endpoint parameter name
    Value: !Sub /${Environment}/${Identifier}/DB/DwEndpoint
