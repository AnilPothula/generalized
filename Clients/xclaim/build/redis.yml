---
AWSTemplateFormatVersion: 2010-09-09

# A CloudFormation template to create/configure an AWS ElastiCache Cluster based on parameters,
# along with an associated security group and subnet group.
#
# You can specify either redis or memcached as an engine, the node (aka instance) type, and
# the number of nodes.
#
# From the Startup Kit Templates, this template requires the name of an existing vpc.cfn.yml stack as
# a parameter.
#
# This template is released under Apache Version 2.0, and can be forked, copied, modified,
# customized, etc. to match your application/system requirements.

Description: SASKV5N ElastiCache and related resources

Parameters:
  Identifier:
    Default: xclaim-id
    Description: Identifier for all the infrastructure.
    Type: String

  OwnerName:
    Default: xclaim
    Description: Owner of the infrastructure
    Type: String

  StackName:
    Default: redis
    Description: Name of the stack
    Type: String

  # ElastiCache stack creation prerequisite:  First create a VPC stack - see README for more info
  NetworkStackName:
    Description: Active CloudFormation stack containing VPC resources
    Type: String
    MinLength: 1
    MaxLength: 255
    AllowedPattern: "^[a-zA-Z][-a-zA-Z0-9]*$"

  CacheNodeType:
    Description: Cache node instance class, e.g. cache.t2.micro(free tier). See https://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/CacheNodes.SelectSize.html
    Type: String
    Default: cache.t2.micro
    ConstraintDescription: Node instance class not supported
    AllowedValues:
      - cache.t2.micro
      - cache.t2.small
      - cache.t2.medium
      - cache.m4.large
      - cache.m4.xlarge
      - cache.m4.2xlarge
      - cache.m4.4xlarge
      - cache.m4.10xlarge
      - cache.r4.large
      - cache.r4.xlarge
      - cache.r4.2xlarge
      - cache.r4.4xlarge
      - cache.r4.8xlarge
      - cache.r4.16xlarge

  AutoMinorVersionUpgrade:
    Description: Whether or not minor version upgrades to the cache engine should be applied automatically during the maintenance window.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
  
  EnvironmentName:
    Type: String
    Description: Environment name (RAILS_ENV)
    Default: staging
    AllowedValues:
      - dev
      - staging
      - production
      - demo

Resources:
  SubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Cache Subnet Group
      SubnetIds:
        - Fn::ImportValue: !Sub ${NetworkStackName}-PrivateSubnet1ID
        - Fn::ImportValue: !Sub ${NetworkStackName}-PrivateSubnet2ID

  RedisCluster:
    Type: AWS::ElastiCache::CacheCluster
    Properties:
      AutoMinorVersionUpgrade: !Ref AutoMinorVersionUpgrade
      Engine: redis
      ClusterName: !Sub ${Identifier}-${EnvironmentName}
      CacheNodeType: !Ref CacheNodeType
      NumCacheNodes: 1
      CacheSubnetGroupName: !Ref SubnetGroup
      VpcSecurityGroupIds:
        - Fn::ImportValue: !Sub ${NetworkStackName}-RedisGroupID
        - Fn::ImportValue: !Sub ${NetworkStackName}-BastionGroupID
      Tags:
      - Key: Name
        Value: !Sub ${Identifier}-${EnvironmentName}-RedisCluster
      - Key: Owner
        Value: !Ref OwnerName
      - Key: StackName
        Value: !Ref StackName
      - Key: Environment
        Value: !Ref EnvironmentName

Outputs:

  RedisStackName:
    Description: Redis Stack Name
    Value: !Ref StackName
    Export:
      Name: !Sub ${StackName}-RedisName

  RedisClusterArn:
    Description: Redis Cluster Arn
    Value: !Sub arn:aws:elasticache:${AWS::Region}:${AWS::AccountId}:cluster/${RedisCluster}
    Export:
      Name: !Sub ${StackName}-RedisClusterArn

  RedisClusterId:
    Description: Redis Cluster ID
    Value: !Ref RedisCluster
    Export:
      Name: !Sub ${StackName}-RedisClusterID

  RedisEngine:
    Description: Redis engine
    Value: redis
    Export:
      Name: !Sub ${StackName}-RedisEngine

  RedisAddress:
    Description: Redis endpoint address
    Value: !GetAtt RedisCluster.RedisEndpoint.Address
    Export:
      Name: !Sub ${StackName}-RedisAddress

  RedisPort:
    Description: Redis port
    Value: 6379
    Export:
      Name: !Sub ${StackName}-RedisPort
